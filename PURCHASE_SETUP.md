# 구매 시스템 설정 가이드

## 개요

이 가이드는 Supabase를 사용한 온라인 강의 구매 시스템 설정 방법을 설명합니다.

## 1. Supabase 테이블 생성

### 1.1 SQL 스크립트 실행

1. Supabase 대시보드에 로그인합니다.
2. 왼쪽 메뉴에서 **SQL Editor**를 클릭합니다.
3. **New Query**를 클릭합니다.
4. `supabase_purchases_setup.sql` 파일의 내용을 복사하여 붙여넣습니다.
5. **Run** 버튼을 클릭하여 실행합니다.

### 1.2 생성되는 테이블

#### courses 테이블
- 강의 정보를 저장하는 테이블
- 모든 사용자가 조회 가능 (RLS 정책)

#### purchases 테이블
- 구매 내역을 저장하는 테이블
- 사용자는 자신의 구매 내역만 조회/생성 가능 (RLS 정책)
- 중복 구매 방지 (UNIQUE 제약조건)

## 2. 구매 프로세스

### 2.1 구매 흐름

```
사용자 → 구매 버튼 클릭 → 로그인 확인 → 구매 확인 다이얼로그
  → API 호출 (/api/purchase) → Supabase에 구매 내역 저장
  → 구매 완료 알림 → 페이지 새로고침
```

### 2.2 API 엔드포인트

**POST /api/purchase**

**요청 본문:**
```json
{
  "courseId": "강의 UUID",
  "price": 99000,
  "title": "강의 제목"
}
```

**성공 응답 (200):**
```json
{
  "success": true,
  "purchase": {
    "id": "구매 UUID",
    "courseId": "강의 UUID",
    "price": 99000,
    "createdAt": "2026-01-25T00:00:00Z"
  },
  "message": "구매가 완료되었습니다."
}
```

**에러 응답:**
- `401`: 인증 필요 (로그인하지 않음)
- `400`: 잘못된 요청 (강의 ID 없음, 이미 구매함)
- `404`: 강의를 찾을 수 없음
- `500`: 서버 오류

## 3. 보안 설정

### 3.1 Row Level Security (RLS)

- **courses 테이블**: 모든 사용자가 조회 가능
- **purchases 테이블**: 
  - 사용자는 자신의 구매 내역만 조회 가능
  - 사용자는 자신의 구매 내역만 생성 가능

### 3.2 중복 구매 방지

- `purchases` 테이블에 `UNIQUE(user_id, course_id)` 제약조건 설정
- 같은 사용자가 같은 강의를 중복 구매할 수 없음

## 4. 코드 구조

### 4.1 구매 버튼 컴포넌트
- 위치: `src/components/PurchaseButton.jsx`
- 기능:
  - 사용자 인증 상태 확인
  - 구매 상태 확인 (이미 구매했는지)
  - 구매 확인 다이얼로그
  - API 호출 및 에러 처리

### 4.2 구매 API
- 위치: `src/app/api/purchase/route.js`
- 기능:
  - 사용자 인증 확인
  - 강의 존재 여부 확인
  - 중복 구매 확인
  - Supabase에 구매 내역 저장

### 4.3 구매 내역 컴포넌트
- 위치: `src/components/PurchaseHistory.jsx`
- 기능:
  - 사용자의 구매 내역 조회
  - 구매한 강의 목록 표시

## 5. 테스트 방법

### 5.1 구매 테스트

1. 로그인하지 않은 상태에서 구매 버튼 클릭
   - "로그인 후 구매하기" 버튼 표시 확인

2. 로그인 후 구매 버튼 클릭
   - 구매 확인 다이얼로그 표시 확인
   - 구매 완료 후 "구매 완료" 버튼으로 변경 확인

3. 구매 내역 확인
   - 관리 탭에서 구매 내역 확인
   - 구매한 강의가 목록에 표시되는지 확인

### 5.2 중복 구매 방지 테스트

1. 이미 구매한 강의에 대해 다시 구매 버튼 클릭
   - "이미 구매한 강의입니다" 메시지 확인

## 6. 문제 해결

### 6.1 "강의를 찾을 수 없습니다" 오류

- Supabase에 `courses` 테이블이 생성되었는지 확인
- `supabase_purchases_setup.sql` 스크립트를 실행했는지 확인

### 6.2 "구매 처리 중 오류가 발생했습니다" 오류

- Supabase에 `purchases` 테이블이 생성되었는지 확인
- RLS 정책이 올바르게 설정되었는지 확인
- 브라우저 콘솔에서 상세 에러 메시지 확인

### 6.3 구매 내역이 표시되지 않음

- Supabase에서 `purchases` 테이블에 데이터가 저장되었는지 확인
- RLS 정책이 올바르게 설정되었는지 확인
- 사용자가 올바르게 로그인했는지 확인

## 7. 향후 개선 사항

### 7.1 결제 시스템 연동

현재는 `payment_status`가 'completed'로 하드코딩되어 있습니다. 실제 결제 시스템(예: 토스페이먼츠, 아임포트)을 연동할 경우:

1. 결제 시스템 API 호출
2. 결제 성공 시 `payment_status`를 'completed'로 설정
3. 결제 실패 시 'failed'로 설정
4. 환불 시 'refunded'로 설정

### 7.2 이메일 알림

구매 완료 시 사용자에게 이메일 발송:
- Supabase Edge Functions 사용
- 또는 외부 이메일 서비스 (SendGrid, AWS SES 등) 연동

### 7.3 구매 내역 상세 페이지

구매한 강의의 상세 정보를 볼 수 있는 페이지 추가
